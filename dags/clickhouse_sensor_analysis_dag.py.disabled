"""
DAG Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ ClickHouse Ùˆ Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ sensor_data
"""
from datetime import datetime, timedelta
from airflow import DAG
from airflow.operators.python import PythonOperator
import clickhouse_connect

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ DAG
default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'start_date': datetime(2024, 10, 15),
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': 1,
    'retry_delay': timedelta(minutes=5),
}

def test_clickhouse_connection():
    """
    ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ ClickHouse
    """
    try:
        # Ø§ØªØµØ§Ù„ Ø¨Ù‡ ClickHouse
        client = clickhouse_connect.get_client(
            host='clickhouse',
            port=8123,
            username='airflow',
            password='clickhouse1234',
            database='analytics'
        )
        
        # ØªØ³Øª Ø³Ø§Ø¯Ù‡
        result = client.command('SELECT version()')
        print(f"âœ… Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚! ClickHouse Version: {result}")
        
        return "Connection successful"
    
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: {str(e)}")
        raise


def fetch_sensor_data():
    """
    Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ sensor_data Ø§Ø² ClickHouse
    """
    try:
        # Ø§ØªØµØ§Ù„
        client = clickhouse_connect.get_client(
            host='clickhouse',
            port=8123,
            username='airflow',
            password='clickhouse1234',
            database='analytics'
        )
        
        # Query
        query = """
        SELECT 
            timestamp,
            sensor_id,
            temperature,
            humidity,
            pressure
        FROM sensor_data
        ORDER BY timestamp
        """
        
        # Ø§Ø¬Ø±Ø§ÛŒ query
        result = client.query(query)
        
        # Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
        print(f"\n{'='*60}")
        print(f"ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§: {len(result.result_rows)}")
        print(f"{'='*60}\n")
        
        # Ù†Ù…Ø§ÛŒØ´ 5 Ø±Ú©ÙˆØ±Ø¯ Ø§ÙˆÙ„
        print("ğŸ“‹ 5 Ø±Ú©ÙˆØ±Ø¯ Ø§ÙˆÙ„:\n")
        print(f"{'Timestamp':<20} {'Sensor':<10} {'Temp':<8} {'Humid':<8} {'Press':<10}")
        print("-" * 60)
        
        for row in result.result_rows[:5]:
            timestamp, sensor_id, temp, humid, press = row
            print(f"{str(timestamp):<20} {sensor_id:<10} {temp:<8.2f} {humid:<8.2f} {press:<10.2f}")
        
        if len(result.result_rows) > 5:
            print(f"\n... Ùˆ {len(result.result_rows) - 5} Ø±Ú©ÙˆØ±Ø¯ Ø¯ÛŒÚ¯Ø±\n")
        
        # Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ
        print(f"\n{'='*60}")
        print("ğŸ“ˆ Ø¢Ù…Ø§Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:")
        print(f"{'='*60}")
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø± Ø¨Ø§ Python
        temps = [row[2] for row in result.result_rows]
        humids = [row[3] for row in result.result_rows]
        pressures = [row[4] for row in result.result_rows]
        
        print(f"ğŸŒ¡ï¸  Temperature: min={min(temps):.2f}, max={max(temps):.2f}, avg={sum(temps)/len(temps):.2f}")
        print(f"ğŸ’§ Humidity:    min={min(humids):.2f}, max={max(humids):.2f}, avg={sum(humids)/len(humids):.2f}")
        print(f"ğŸŒ¬ï¸  Pressure:    min={min(pressures):.2f}, max={max(pressures):.2f}, avg={sum(pressures)/len(pressures):.2f}")
        
        # Ø³Ù†Ø³ÙˆØ±Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
        sensors = list(set([row[1] for row in result.result_rows]))
        print(f"\nğŸ¯ Ø³Ù†Ø³ÙˆØ±Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯: {', '.join(sensors)}")
        print(f"{'='*60}\n")
        
        return len(result.result_rows)
    
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡: {str(e)}")
        raise


def analyze_sensor_stats(**context):
    """
    Ø¢Ù†Ø§Ù„ÛŒØ² Ù¾ÛŒØ´Ø±ÙØªÙ‡â€ŒØªØ± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    """
    try:
        client = clickhouse_connect.get_client(
            host='clickhouse',
            port=8123,
            username='airflow',
            password='clickhouse1234',
            database='analytics'
        )
        
        # Query Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø± Ù‡Ø± Ø³Ù†Ø³ÙˆØ±
        query = """
        SELECT 
            sensor_id,
            COUNT(*) as record_count,
            AVG(temperature) as avg_temp,
            AVG(humidity) as avg_humid,
            AVG(pressure) as avg_press,
            MIN(temperature) as min_temp,
            MAX(temperature) as max_temp
        FROM sensor_data
        GROUP BY sensor_id
        ORDER BY sensor_id
        """
        
        result = client.query(query)
        
        print(f"\n{'='*80}")
        print("ğŸ“Š Ø¢Ù…Ø§Ø± ØªÙÚ©ÛŒÚ©ÛŒ Ù‡Ø± Ø³Ù†Ø³ÙˆØ±")
        print(f"{'='*80}\n")
        
        print(f"{'Sensor':<12} {'Count':<8} {'Avg Temp':<10} {'Avg Humid':<12} {'Avg Press':<12} {'Temp Range':<15}")
        print("-" * 80)
        
        for row in result.result_rows:
            sensor_id, count, avg_t, avg_h, avg_p, min_t, max_t = row
            temp_range = f"{min_t:.1f}-{max_t:.1f}"
            print(f"{sensor_id:<12} {count:<8} {avg_t:<10.2f} {avg_h:<12.2f} {avg_p:<12.2f} {temp_range:<15}")
        
        print(f"\n{'='*80}\n")
        
        # Ø°Ø®ÛŒØ±Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ task Ø¨Ø¹Ø¯ÛŒ (Ø¯Ø± XCom)
        ti = context['ti']
        total_records = sum([row[1] for row in result.result_rows])
        ti.xcom_push(key='total_records', value=total_records)
        
        print(f"âœ… ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ ({total_records}) Ø¯Ø± XCom Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯")
        
        return "Analysis completed"
    
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù†Ø§Ù„ÛŒØ²: {str(e)}")
        raise


def print_summary(**context):
    """
    Ø®Ù„Ø§ØµÙ‡ Ù†Ù‡Ø§ÛŒÛŒ
    """
    ti = context['ti']
    total_records = ti.xcom_pull(key='total_records', task_ids='analyze_stats')
    
    print(f"\n{'='*60}")
    print("ğŸ‰ Ø®Ù„Ø§ØµÙ‡ Ø§Ø¬Ø±Ø§")
    print(f"{'='*60}")
    print(f"âœ… Ø§ØªØµØ§Ù„ Ø¨Ù‡ ClickHouse: Ù…ÙˆÙÙ‚")
    print(f"âœ… Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡: Ù…ÙˆÙÙ‚")
    print(f"âœ… Ø¢Ù†Ø§Ù„ÛŒØ²: Ù…ÙˆÙÙ‚")
    print(f"ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§: {total_records}")
    print(f"{'='*60}\n")
    
    print("ğŸ¯ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ÛŒ: Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ PCA!")


# ØªØ¹Ø±ÛŒÙ DAG
with DAG(
    'clickhouse_sensor_test',
    default_args=default_args,
    description='ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ ClickHouse Ùˆ Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ù†Ø³ÙˆØ±',
    schedule_interval=None,  # ÙÙ‚Ø· manual trigger
    catchup=False,
    tags=['clickhouse', 'test', 'sensors'],
) as dag:
    
    # Task 1: ØªØ³Øª Ø§ØªØµØ§Ù„
    test_connection = PythonOperator(
        task_id='test_connection',
        python_callable=test_clickhouse_connection,
    )
    
    # Task 2: Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡
    fetch_data = PythonOperator(
        task_id='fetch_data',
        python_callable=fetch_sensor_data,
    )
    
    # Task 3: Ø¢Ù†Ø§Ù„ÛŒØ² Ø¢Ù…Ø§Ø±ÛŒ
    analyze_stats = PythonOperator(
        task_id='analyze_stats',
        python_callable=analyze_sensor_stats,
        provide_context=True,
    )
    
    # Task 4: Ø®Ù„Ø§ØµÙ‡ Ù†Ù‡Ø§ÛŒÛŒ
    summary = PythonOperator(
        task_id='print_summary',
        python_callable=print_summary,
        provide_context=True,
    )
    
    # ØªØ¹Ø±ÛŒÙ ØªØ±ØªÛŒØ¨ Ø§Ø¬Ø±Ø§
    test_connection >> fetch_data >> analyze_stats >> summary
